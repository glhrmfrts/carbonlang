// test stuff

import std::io;
import std::rawstring;
import std::memory as mem;
import std::libc::stdio;
import std::libc::stdlib;

func print_the_char(v: char, d: *char) {
    puts(&v);
}

func longfunc(a: int, b: int, c: int, d: int, e: int, f: int, g: int, h: int): int {
    return a + b + c + d + e + f + g + h;
}

func test_longfunc() {
    let result = longfunc(1, 2, 3, 4, 5, 6, 7, 8);
    if (result == 36) {
        println("[OK] test_longfunc");
    }
    else {
        println("[NOK] test_longfunc");
    }
}

func test_strcopy_len() {
    let str = "hello";
    let newstr = str.copy;

    if (str.len == newstr.len) {
        println("[OK] test_strcopy_len");
    }
    else {
        println("[NOK] test_strcopy_len");
    }

    mem::dealloc(cast[raw_ptr] newstr);
}

func test_strcopy() {
    let str = "hello";
    let newstr = copy(str);

    if (str[0] == newstr[0] && str[1] == newstr[1] && str[2] == newstr[2] && str[3] == newstr[3] && str[4] == newstr[4]) {
        println("[OK] test_strcopy");
    }
    else {
        println("[NOK] test_strcopy");
    }

    mem::dealloc(cast[raw_ptr] newstr);
}

func test_strcopy_saving() {
    let str = "hello";
    let newstr = copy(str);

    let c1 = str[0] == newstr[0];
    let c2 = str[1] == newstr[1];
    let c3 = str[2] == newstr[2];
    let c4 = str[3] == newstr[3];
    let c5 = str[4] == newstr[4];

    if (c1 && c2 && c3 && c4 && c5) {
        println("[OK] test_strcopy_saving");
    }
    else {
        println("[NOK] test_strcopy_saving");
    }
    
    mem::dealloc(cast[raw_ptr] newstr);
}

func test_while_statement() {
    let str = "hello";
    let newstr = copy(str);

    var i = 0;
    while (i < 5) {
        newstr[i] = 'G';
        i = i + 1;
    }

    //println(newstr);

    if (i < 5) {
        println("asdasd");
    }

    if (equals(newstr, "GGGGG") && !equals(newstr, "foobar")) {
        println("[OK] test_while_statement");
    }
    else {
        println("[NOK] test_while_statement");
    }
    
    mem::dealloc(cast[raw_ptr] newstr);
}

func test_short(): bool {
    println("SHOULD NOT PRINT THIS");
    return true;
}

func test_for_stmt() {
    let newstr = "helloworld".copy;
    for (i in 0 .. newstr.len) {
        let c = '0' + cast[int8] i;
        newstr[i] = c;
    }
    if (equals(newstr, "0123456789")) {
        //println(newstr);
        println("[OK] test_for_stmt");
    }
    else {
        println("[NOK] test_for_stmt");
    }
    mem::dealloc(cast[raw_ptr] newstr);
}

func test_struct_zeroinit() {
    var a: range[int];
    var b: range[int] = {};

    if ((a.start == 0 && a.end == 0) && (b.start == 0 && b.end == 0)) {
        println("[OK] test_struct_zeroinit");
    }
    else {
        println("[NOK] test_struct_zeroinit");
    }
}

func test_struct_init() {
    let a: range[int] = { 3, 5 };
    let b: range[int] = { 24*7+2, a.end };
    let c = range[int]{ b.start*3*9, b.end*2*2 };
    let d = range[int]{};

    if ((a.start == 3 && a.end == 5) && (b.start == 24*7+2 && b.end == a.end) && (c.start == b.start*3*9 && c.end && b.end*2*2)) {
        println("[OK] test_struct_init");
    }
    else {
        println("[NOK] test_struct_init");
    }
}

func test_tuple_zeroinit() {
    var a: {int, int};
    var b: {raw_string, bool};

    if ((a[0] == 0 && a.second == 0) && (equals(b[0], "") && b[1] == false)) {
        println("[OK] test_tuple_zeroinit");
    }
    else {
        println("[NOK] test_tuple_zeroinit");
    }
}

func test_tuple_init() {
    let a = {3, 4, 5};
    let b = {"nice", "second", false};

    if ((a.first == 3 && a.second == 4 && a.third == 5) && (equals(b[0], "nice") && equals(b[1], "second") && !b[2])) {
        println("[OK] test_tuple_init");
    }
    else {
        println("[NOK] test_tuple_init");
    }
}

func test_struct_assignment_lvalue() {
    let a: range[usize] = { 3, 5 };
    let b = a;

    if (a.start == b.start && a.end == b.end) {
        println("[OK] test_struct_assignment_lvalue");
    }
    else {
        println("[NOK] test_struct_assignment_lvalue");
    }
}


func sum_range_ptr(r: *range[usize]): usize {
    return r.start + r.end;
}

func sum_range_ptr(r: !range[usize]): usize {
    return r.start + r.end;
}

func sum_range_val(r: range[usize]): usize {
    return r.start + r.end;
}

func sum_range_copy(r: range[usize]): usize {
    let r2 = r;
    return r2.start + r2.end;
}

func test_struct_argument(): {} {
    let a: range[usize] = { 10, 20 };

    let result = sum_range_ptr(&a);
    let valres = sum_range_val(a);
    let cpres  = sum_range_copy(a);

    if (result == 30 && valres == 30 && cpres == 30) {
        println("[OK] test_struct_argument");
    }
    else {
        println("[NOK] test_struct_argument");
    }
}

func get_result(): int { return 2; }

func main(): int {  
    //let result = get_result();

    test_longfunc();
    test_strcopy_len();
    test_strcopy();
    test_strcopy_saving();
    test_while_statement();
    test_for_stmt();
    test_struct_zeroinit();
    test_struct_init();
    test_tuple_zeroinit();
    test_tuple_init();
    test_struct_assignment_lvalue();
    test_struct_argument();

    //mem::dealloc(cast[raw_ptr] newtext);
    //return a[0];//result*2;

    //let s = "adqwe";
    //var a: *raw_string = &s;
    //return a[0][0];

    let a = "asdasd000000000";
    let b = "\0\0\n";

    return a[b[get_result()]];
}